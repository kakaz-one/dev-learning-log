# 「3.1.4　浮動小数点数の演算に注意」で起きたエラーとその解除までの道のり

**日付**: 2025年9月5日  
**学習内容**: PHP BCMath拡張エラーの解決  
**環境**: WSL (Windows Subsystem for Linux) - PHP 8.1

## 発生した問題

PHPでBCMath関数を使用したコードを実行したところ、以下のエラーが発生:

```
PHP Fatal error: Uncaught Error: Call to undefined function bcadd() in /mnt/c/xampp/htdocs/php_test/chap03/float2.php:3
```

**対象コード**:
```php
<?php
$add = bcadd(0.1, 0.7, 1);
$mul = bcmul($add, 10, 1);
print floor($mul);
?>
```

## 解決までの流れ

### 1. 問題の特定
最初はコードの論理エラーを疑ったが、実際はBCMath拡張モジュールが有効になっていないことが判明。

### 2. 環境の確認
現在使用しているphp.iniファイルの場所を確認:
```bash
php -r "echo php_ini_loaded_file();"
```
**結果**: `/etc/php/8.1/cli/php.ini`

この結果から、WSL環境でPHPを実行していることが判明。Windows XAMPPの設定ファイルとは異なることを理解。

### 3. BCMath拡張の状況確認
BCMath拡張が有効かどうか確認:
```bash
php -r "if (extension_loaded('bcmath')) { echo 'BCMath有効'; } else { echo 'BCMath無効'; }"
```

### 4. php.iniファイルの編集
WSL環境のphp.iniファイルを編集:
```bash
sudo nano /etc/php/8.1/cli/php.ini
```

**編集作業**:
- `Ctrl + W` で検索機能を使用
- "Dynamic Extensions" セクションを発見
- 既存の拡張モジュールリストに `extension=bcmath` を追加
- `;extension=bz2` の前に挿入

**最終的な設定**:
```ini
extension=bcmath
;extension=bz2
;extension=curl
```

### 5. 設定保存とテスト
ファイル保存後、BCMathが有効になったか確認:
```bash
php -m | grep bcmath
```

**結果**: エラーが発生
```
PHP Warning: PHP Startup: Unable to load dynamic library 'bcmath' (...: cannot open shared object file: No such file or directory)
```

### 6. 根本的な解決
php.iniで有効にしただけでは不十分で、実際の拡張ファイルをインストールする必要があることが判明:

```bash
sudo apt update
sudo apt install php8.1-bcmath
```

### 7. 最終確認
```bash
php -m | grep bcmath
```
**結果**: 
```
PHP Warning: Module "bcmath" is already loaded in Unknown on line 0
bcmath
```

警告は出るが、BCMathが正常に動作することを確認。

### 8. コードの実行テスト
```bash
php chap03/float2.php
```
正常に実行され、期待した結果「8」が出力された。

## 学んだこと

### 技術的な学習
1. **PHP拡張モジュールの仕組み**
   - php.iniでの設定だけでなく、実際の拡張ファイルのインストールが必要
   - Linuxではapt-getでパッケージ管理

2. **環境の違いの理解**
   - WSL環境とWindows XAMPP環境は完全に別物
   - 設定ファイルの場所や管理方法が異なる

3. **デバッグコマンド**
   - `php -m`: インストール済み拡張の確認
   - `php -r "code"`: PHPコードをコマンドラインで実行
   - `extension_loaded()`: 特定拡張の有効状況確認

### 問題解決スキル
1. **エラーメッセージの正確な読み取り**
2. **段階的なアプローチ**
   - 環境確認 → 設定確認 → 修正 → テスト のサイクル
3. **複数の解決手段の試行**
   - 設定変更とパッケージインストールの組み合わせ

### nanoエディタの操作
- `Ctrl + W`: 検索
- `Ctrl + O`: 保存
- `Ctrl + X`: 終了
- 矢印キーでの移動

## 改善点・今後の課題

1. **事前の環境確認の重要性**
   - 使用している環境（WSL/Windows/Linux）の把握
   - 必要な拡張モジュールの事前インストール

2. **BCMath使用のベストプラクティス**
   - 数値を文字列で渡す: `bcadd('0.1', '0.7', 1)`
   - 適切な精度の指定

3. **エラー対応の効率化**
   - 類似エラーのパターン学習
   - 環境構築のチェックリスト作成

## 所要時間
**約45分** (問題発生から解決まで)

## 次回への活用
このような拡張モジュール関連のエラーが発生した際の対応手順を確立できた。他の拡張（GD、cURL等）でも同様のアプローチが適用可能。